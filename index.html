<!DOCTYPE html>
<html lang="vn">
	<head>
		<meta charset="UTF-8">
		<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
		<meta content="width=device-width, initial-scale=1" name="viewport">
		<base href="https://hiepdeep.github.io/">
		<link rel="icon" href="favicon/hiepdeep.ico">
		<title>Messages | V1.0.1</title>
		<meta name="title" content="HiepDeep">
		<meta name="description" content="HiepDeep">
		<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
		<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
		<link rel="stylesheet" href="library/style/oneforall.css">
		<link rel="stylesheet" href="library/style/home-page.css">
	</head>
	<body>
		<div id="preloader">
			<svg viewbox="0 0 240 240">
				<circle cx="120" cy="120" r="90"></circle>
			</svg>
		</div>
		<div class="app">
			<div class="header">
				<div class="magin-row">
					<div class="aside aside-left">
						<img src="https://hiepdeep.github.io/library/pictures/live-chat-outlined.png" alt="">
					</div>
					<div class="aside aside-right" id="user-logged">
						<a href="javascript:;"></a>
						<button id="btn-logout" class="material-icons">logout</button>
					</div>
				</div>
			</div>
			<div class="body">
				<div class="magin-row">
					<div class="aside aside-left">
						<div id="totalUser">Total Users: 0</div>
						<div id="user-lists"></div>
					</div>
					<div class="aside aside-center" id="messages-data">
						<div id="toYour"></div>
						<div id="messages">
							<div id="chats"></div>
						</div>
						<div id="submitChat">
							<div class="input">
								<textarea name="" id="sendChat" rows="1" placeholder="Aa"></textarea>
							</div>
						</div>
					</div>
					<div class="aside aside-right">
						<div class="widget">
							<h2 class="widget-title">widget-title</h2>
							<div class="widget-content">widget-content</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript">
			console.clear();
			window.addEventListener("load", (event) => {
				document.getElementById("preloader").classList.add("finished");
			});
			const app = firebase.initializeApp({
				databaseURL: "https://hiepdeep-default-rtdb.firebaseio.com"
			});
			const database = firebase.database();
			const accounts = "authentication";
			const messages = "messages";
			const loggedInUsername = localStorage.getItem("hiepdeep-github-io-authentication") ? window.atob(localStorage.getItem("hiepdeep-github-io-authentication")) : null;
			let $check_in_arr = [];
			database.ref(accounts).on("value", (snapshot) => {
				if (snapshot.exists()) {
					let data = snapshot.val();
					let data_keys = Object.keys(data);
					$check_in_arr = data_keys;
				}
			});
			if (loggedInUsername) {
				database.ref(`${accounts}/${loggedInUsername}`).once("value", (snapshot) => {
					if (snapshot.exists()) {
						let data = snapshot.val();
						document.getElementById("user-logged").innerHTML = `
							<a href="https://hiepdeep.github.io/profile/?ref=${data.private.username}">${data.info.lastname} ${data.info.firstname}</a>
							<button id="btn-logout" class="material-icons">logout</button>
						`;
						document.getElementById("btn-logout").addEventListener("click", (e) => {
							e.preventDefault();
							database.ref(`${accounts}/${loggedInUsername}/status/online`).set("0");
							localStorage.removeItem("hiepdeep-github-io-authentication");
							window.location.href = window.location.href;
						});
					}
				});
				database.ref(accounts).on("value", (snapshot) => {
					if (snapshot.exists()) {
						document.getElementById("totalUser").innerText = "Total Users: " + (snapshot.numChildren() - 1);
						let $userlists = "";
						for (let e in $check_in_arr) {
							if ($check_in_arr[e] != loggedInUsername) {
								database.ref(`${accounts}/${$check_in_arr[e]}`).once("value", (snapshot) => {
									if (snapshot.exists()) {
										let x = snapshot.val();
										if (x && x.info) {
											if (x.status && x.status.online === "1") {
												$userlists += `
													<div class="user onl" data-messages-userid="${x.userid}">
														<div class="user-thumb">
															<img src="https://hiepdeep.netlify.app/library/picture/z.png" alt="">
														</div>
														<div class="user-data">
															<span class="fullname">${x.info.lastname} ${x.info.firstname}</span>
															<span class="lastmess">${x.private.username}</span>
														</div>
													</div>
												`;
											}
											else if (x.status && x.status.online === "0") {
												$userlists += `
													<div class="user" data-messages-userid="${x.userid}">
														<div class="user-thumb">
															<img src="https://hiepdeep.netlify.app/library/picture/z.png" alt="">
														</div>
														<div class="user-data">
															<span class="fullname">${x.info.lastname} ${x.info.firstname}</span>
															<span class="lastmess">${x.private.username}</span>
														</div>
													</div>
												`;
											}
										}
										else {
											console.warn(`Dữ liệu người dùng ${$check_in_arr[e]} không có thông tin "info"`);
										}
									}
								});
							}
						}
						document.getElementById("user-lists").innerHTML = $userlists;
						let sendTo = "";
						let listitem = document.getElementById("user-lists").getElementsByClassName("user");
						for (let c = 0; c < listitem.length; c++) {
							listitem[c].addEventListener("click", (e) => {
								e.preventDefault();
								for (let d = 0; d < listitem.length; d++) {
									listitem[d].classList.remove("focus");
								}
								listitem[c].classList.add("focus");
								sendTo = window.atob(listitem[c].getAttribute("data-messages-userid"))
								database.ref(`${accounts}/${sendTo}`).once("value", (snapshot) => {
									let x = snapshot.val();
									document.getElementById("toYour").innerHTML = `
										<div class="picture">
											<img src="https://hiepdeep.netlify.app/library/picture/z.png" alt="">
										</div>
										<div class="data-user">
											<div class="fullname">${x.info.lastname} ${x.info.firstname}</div>
											<div class="username">${x.private.username}</div>
										</div>
									`;
								});
								updateChat(loggedInUsername, sendTo);
								document.getElementById("toYour").style.display = "flex";
								document.getElementById("messages").style.display = "block";
								document.getElementById("submitChat").style.display = "block";
								document.getElementById("sendChat").value = "";
							});
						}
						let sendvalue = "";
						document.getElementById("sendChat").addEventListener("input", function(event) {
							sendvalue = document.getElementById("sendChat").value.trim();
						});
						document.getElementById("sendChat").addEventListener("keydown", function(event) {
							if (!event.shiftKey && event.key === "Enter") {
								if (sendvalue.length > 0) {
									sendChatssss(loggedInUsername, sendTo, to_slug(sendvalue));
									updateChat(loggedInUsername, sendTo);
									document.getElementById("sendChat").value = sendvalue = "";
									document.getElementById("sendChat").style.height = "48px";
								} else {
									alert("Vui lòng nhập tin nhắn.");
									document.getElementById("sendChat").value = sendvalue = "";
									document.getElementById("sendChat").style.height = "48px";
								}
								event.preventDefault();
							}
						});
					}
				});
			} else {
				window.location.href = "authentication/login";
			}
			function sendChatssss(from, to, contents) {
				database.ref(messages).push({
					sendFrom: from,
					sendTo: to,
					contents: contents,
					timeamp: timesampAll()
				});
			}
			function updateChat(from, to) {
				database.ref(messages).on("child_added", (snapshot) => {
					const message = snapshot.val();
					if ((from === message.sendFrom && to === message.sendTo) || (from === message.sendTo && to === message.sendFrom)) {
						document.getElementById("chats").innerHTML = "";
						let displayChats = "";
						if (from === message.sendFrom && to === message.sendTo) {
							displayChats += `
								<div class="chat right">
									<div class="timeamp">${timeampPro(message.timeamp)}</div>
									<div class="content">${message.contents}</div>
								</div>
							`;
						} else {
							displayChats += `
								<div class="chat">
									<div class="timeamp">${timeampPro(message.timeamp)}</div>
									<div class="content">${message.contents}</div>
								</div>
							`;
						}
						document.getElementById("chats").innerHTML += displayChats;
						document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
					}
				});
			}
			function timesampAll() {
				let getTime = new Date();
				let timeYear = getTime.getFullYear();
				let timeMonth = getTime.getMonth() + 1;
				let timeDate = getTime.getDate();
				let timeHours = getTime.getHours();
				let timeMinutes = getTime.getMinutes();
				let timeSeconds = getTime.getSeconds();
				let timeMilliseconds = getTime.getMilliseconds();
				return `${timeYear}/${timeMonth}/${timeDate} ${timeHours}:${timeMinutes}:${timeSeconds}:${timeMilliseconds}`;
			}
			function timeampPro(timeString) {
				const now = new Date();
				const timeWithoutMilliseconds = timeString.replace(/:(\d+)$/, '');
				const past = new Date(timeWithoutMilliseconds.replace(/-/g, '/'));
				const seconds = Math.floor((now - past) / 1000);
				const minutes = Math.floor(seconds / 60);
				const hours = Math.floor(minutes / 60);
				const days = Math.floor(hours / 24);
				if (days > 0) {
					return `${days} ngày trước`;
				}
				else if (hours > 0) {
					return `${hours} giờ trước`;
				}
				else if (minutes > 0) {
					return `${minutes} phút trước`;
				}
				else {
					return "vài giây trước";
				}
			}
			function to_slug(str) {
				return str
					.replace(/&/g, "&amp;")
					.replace(/</g, "&lt;")
					.replace(/>/g, "&gt;")
					.replace(/"/g, "&quot;")
					.replace(/'/g, "&#039;")
					.replace(/\n/g, "<br>");
			}
			document.querySelectorAll("textarea").forEach(el => {
				el.style.height = el.setAttribute("style", "height: 48px");
				el.classList.add("auto");
				el.addEventListener("input", e => {
					el.style.height = "auto";
					el.style.height = (el.scrollHeight) + "px";
				});
			});
		</script>
	</body>
</html>
