<!DOCTYPE html>
<html lang="vn">
	<head>
		<meta charset="UTF-8">
		<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
		<meta content="width=device-width, initial-scale=1" name="viewport">
		<base href="https://hiepdeep.github.io/">
		<link rel="icon" href="library/favicon/logo-light.ico">
		<title>Social Media | V1.0.0</title>
		<meta name="title" content="HiepDeep">
		<meta name="description" content="HiepDeep">
		<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
		<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
		<script src="library/script/config-firebase.js"></script>
		<script src="library/script/loading.js"></script>
		<link rel="stylesheet" href="library/style/oneforall.css">
		<link rel="stylesheet" href="library/style/loading.css">
		<link rel="stylesheet" href="library/style/home-page.css">
	</head>
	<body>
		<div id="preloader">
			<svg viewbox="0 0 240 240">
				<circle cx="120" cy="120" r="90">
				</circle>
			</svg>
		</div>
		<div id="header"></div>
		<div id="body">
			<div class="margin-block">
				<div id="col-left"></div>
				<div id="col-center"></div>
				<div id="col-right"></div>
			</div>
		</div>
		<script type="text/javascript">
			console.clear();
			document.addEventListener("DOMContentLoaded", () => {
				database.ref(`app/visit`).transaction((currentVisit) => {
					return (currentVisit || 0) + Math.floor(Math.random() * 10);
				});
				database.ref(`app/visit`).on("value", (snapshot) => {
					const visits = snapshot.val() || 0;
					document.getElementById("col-left").textContent = visits;
				});
			});
			const loggedInUser = localStorage.getItem("social-media-auth") ? window.atob(localStorage.getItem("social-media-auth")) : null;
			if ( loggedInUser ) {
				const accounts = "app/authentication";
				let arrUsers = [];
				database.ref(accounts).on("value", (snapshot) => {
					if ( snapshot.exists() ) {
						let data = snapshot.val();
						let object_keys = Object.keys(data);
						arrUsers = object_keys;
					}
				});
				database.ref(`${accounts}/${loggedInUser}`).once("value", (snapshot) => {
					if ( snapshot.exists() ) {
						let data = snapshot.val();
						document.getElementById("header").innerHTML = `
							<div class="margin-block">
								<div class="header-left">
									<div class="logo">
										<a href="https://hiepdeep.github.io">
											<img src="library/pictures/svg/ui-deck.svg" alt="">
										</a>
									</div>
								</div>
								<div class="header-right">
									<div class="nav-right">
										<a href="">Home</a>
										<a href="">About</a>
										<a href="">Contact</a>
										<a href="">Support</a>
									</div>
									<div class="nav-user">
										<a href="ref/profile/?user=${data.private.username}" class="logged-user">
											<div class="thumb" id="logged-user-thumb">
												<img src="${data.info.picture ? data.info.picture : 'library/pictures/no_avt.jpg'}" alt="">
											</div>
											<span class="displayName">${data.info.firstname}</span>
										</a>
										${loggedInUser === "hiepdz" ? '<a href="ref/dashboard" class="dashboard">Dashboard</a>' : ''}
										<button id="btn-logout" class="material-icons">logout</button>
									</div>
								</div>
							</div>
						`;
						document.getElementById("btn-logout").addEventListener("click", (e) => {
							e.preventDefault();
							database.ref(`${accounts}/${loggedInUser}/status`).set({
								online: "0",
								last_time: times()
							});
							localStorage.removeItem("social-media-auth");
							window.location.href = "https://hiepdeep.github.io/ref/auth";
						});
					}
				});
				// widget-right
				database.ref(accounts).once("value", (snapshot) => {
					if ( snapshot.exists() ) {
						let userItems = "";
						for ( let e in arrUsers ) {
							if ( arrUsers[e] != loggedInUser ) {
								database.ref(`${accounts}/${arrUsers[e]}`).once("value", (userItem) => {
									if ( userItem.exists() ) {
										let x = userItem.val();
										userItems += `
											<li>
												<a href="ref/profile/?user=${x.private.username}">
													<div class="thumb ${x.status.online === "1" ? 'onl' : ''}">
														<img src="${x.info.picture ? x.info.picture : 'library/pictures/no_avt.jpg'}" alt="">
													</div>
													<span class="dataName">${x.info.lastname} ${x.info.firstname}</span>
												</a>
											</li>
										`;
									}
								});
							}
						}
						document.getElementById("col-right").innerHTML += `
							<div class="widget" id="listUsers">
								<div class="widget-title"><h2>Người dùng:</h2></div>
								<div class="widget-body">${userItems}</div>
							</div>
						`;
					}
				});
				function times() {
					let getTime = new Date();
					let timeYear = getTime.getFullYear();
					let timeMonth = getTime.getMonth() + 1;
					let timeDate = getTime.getDate();
					let timeHours = getTime.getHours();
					let timeMinutes = getTime.getMinutes();
					let timeSeconds = getTime.getSeconds();
					let timeMilliseconds = getTime.getMilliseconds();
					return `${timeYear}-${timeMonth.padStart(2, "0")}-${timeDate.padStart(2, "0")}-${timeHours.padStart(2, "0")}-${timeMinutes.padStart(2, "0")}-${timeSeconds.padStart(2, "0")}-${timeMilliseconds.padStart(3, "0")}`;
				}
			}
			else {
				window.location.href = "https://hiepdeep.github.io/ref/auth";
			}
		</script>
	</body>
</html>