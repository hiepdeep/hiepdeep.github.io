<!DOCTYPE html>
<html lang="vn">
	<head>
		<meta charset="UTF-8">
		<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
		<meta content="width=device-width, initial-scale=1" name="viewport">
		<base href="https://hiepdeep.github.io/">
		<link rel="icon" href="library/favicon/hiepdeep.ico">
		<title>Social Media | V1.0.0</title>
		<meta name="title" content="HiepDeep">
		<meta name="description" content="HiepDeep">
		<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
		<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
		<script src="library/script/config-firebase.js"></script>
		<script src="library/script/loading.js"></script>
		<link rel="stylesheet" href="library/style/oneforall.css">
		<link rel="stylesheet" href="library/style/loading.css">
		<link rel="stylesheet" href="ref/dashboard/dashboard.css">
	</head>
	<body>
		<div id="preloader">
			<svg viewbox="0 0 240 240">
				<circle cx="120" cy="120" r="90">
				</circle>
			</svg>
		</div>
		<div id="dashboard">
			<div class="aside-left">
				<div class="aside-left-top">
					<div class="logo">
						<a href="">
							<img src="library/pictures/svg/ui-deck.svg" alt="">
						</a>
					</div>
				</div>
				<div class="aside-left-bottom"></div>
			</div>
			<div class="aside-center">
				<div class="aside-center-top">
					<div class="nav-top">
						<a href="javascript:;">Home</a>
					</div>
					<div class="nav-user">
						<a href="javascript:;" class="logged-user">
							<div class="thumb">
								<img src="library/pictures/200/7.png" alt="">
							</div>
							<span class="displayName">Linh</span>
						</a>
						<a href="javascript:;" class="dashboard">Dashboard</a>
						<button id="btn-logout" class="material-icons">logout</button>
					</div>
				</div>
				<div class="aside-center-bottom">
					<div class="grid">
						<div class="item">
							<span class="num">10.000.000</span>
							<span class="text">Views</span>
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 12"><path class="cls-1" d="M22,2a2,2,0,0,1-2,2,1.7,1.7,0,0,1-.51-.07L15.93,7.48A1.77,1.77,0,0,1,16,8a2,2,0,0,1-4,0,1.77,1.77,0,0,1,.07-.52L9.52,4.93a2,2,0,0,1-1,0L3.93,9.49A1.7,1.7,0,0,1,4,10,2,2,0,1,1,2,8a1.7,1.7,0,0,1,.51.07L7.07,3.52A1.77,1.77,0,0,1,7,3a2,2,0,0,1,4,0,1.77,1.77,0,0,1-.07.52l2.55,2.55a2,2,0,0,1,1,0l3.55-3.56A1.7,1.7,0,0,1,18,2a2,2,0,0,1,4,0Z"/></svg>
						</div>
						<div class="item">
							<span class="num">1.000.000</span>
							<span class="text">Users</span>
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 14"><path class="cls-1" d="M15,6a3,3,0,1,0-3-3A3,3,0,0,0,15,6ZM7,6A3,3,0,1,0,4,3,3,3,0,0,0,7,6ZM7,8C4.67,8,0,9.17,0,11.5V14H14V11.5C14,9.17,9.33,8,7,8Zm8,0c-.29,0-.62,0-1,.05a4.22,4.22,0,0,1,2,3.45V14h6V11.5C22,9.17,17.33,8,15,8Z"/></svg>
						</div>
					</div>
					<div class="table">
						<div class="table-title">
							<h2>Danh sách người dùng:</h2>
							<div class="prev_next">
								<span class="material-icons" id="prev">chevron_left</span>
								<span class="material-icons" id="next">chevron_right</span>
							</div>
						</div>
						<table>
							<thead>
								<tr>
									<th><input type="checkbox" id="checkAll" name="" value=""></th>
									<th>ID</th>
									<th>Lname</th>
									<th>Fname</th>
									<th>Birthday</th>
									<th>Sex</th>
									<th>Username</th>
									<th>Password</th>
									<th>Status</th>
								</tr>
							</thead>
							<tbody id="table1"></tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
		<script type="text/javascript">
			console.clear();
			const loggedInUser = localStorage.getItem("social-media-auth") ? window.atob(localStorage.getItem("social-media-auth")) : null;
			if ( loggedInUser === "hiepdz" ) {
				const accounts = "app/authentication";
				let arrUsers = [];
				const tableBody = document.getElementById("table1");
				const checkAll = document.getElementById("checkAll");
				const prevButton = document.getElementById("prev");
				const nextButton = document.getElementById("next");
				const rowsPerPage = 5;
				let currentPage = 1;
				let allUsersData = {}; // Object để lưu trữ thông tin chi tiết của tất cả người dùng
				database.ref(accounts).on("value", (snapshot) => {
					if ( snapshot.exists() ) {
						let data = snapshot.val();
						arrUsers = Object.keys(data);
						fetchAllUsersData(arrUsers.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage));
						updatePaginationButtons();
						document.getElementById("app-users").textContent = makerNumber(arrUsers.length);
					} else {
						arrUsers = [];
						displayTable([]); // Hiển thị bảng trống
						updatePaginationButtons();
						document.getElementById("app-users").textContent = makerNumber(0);
					}
				});
				function fetchAllUsersData(usersToFetch) {
					usersToFetch.forEach(userId => {
						Promise.all([
							database.ref(`${accounts}/${userId}/info`).once("value"),
							database.ref(`${accounts}/${userId}/private`).once("value"),
							database.ref(`${accounts}/${userId}/status`).once("value")
						]).then(([snapshotInfo, snapshotPrivate, snapshotStatus]) => {
							if ( snapshotInfo.exists() && snapshotPrivate.exists() ) {
								const userInfo = snapshotInfo.val();
								const privateInfo = snapshotPrivate.val();
								const statusInfo = snapshotStatus.val() || {
									online: 0
								};
								allUsersData[userId] = {
									info: userInfo,
									private: privateInfo,
									status: statusInfo
								};
							}
							// Kiểm tra nếu đã tải xong dữ liệu cho tất cả người dùng trong trang hiện tại
							if ( Object.keys(allUsersData).length === usersToFetch.length ) {
								displayTable(usersToFetch);
							}
						}).catch(error => {
							console.error("Lỗi khi tải dữ liệu người dùng:", error);
						});
					});
				}
				function displayTable(usersToDisplay) {
					tableBody.innerHTML = "";
					usersToDisplay.forEach(userId => {
						const userData = allUsersData[userId];
						if ( userData ) {
							const row = tableBody.insertRow();
							row.insertCell().innerHTML = `<input type="checkbox" id="user-${userId}" name="selectedUsers" value="${userId}">`;
							row.insertCell().textContent = userId;
							row.insertCell().textContent = userData.info?.lastname || "";
							row.insertCell().textContent = userData.info?.firstname || "";
							row.insertCell().textContent = userData.info?.birthday || "";
							row.insertCell().textContent = userData.info?.sex || "";
							row.insertCell().textContent = userData.private?.username || "";
							row.insertCell().textContent = userData.private?.password || "";
							row.insertCell().textContent = userData.status?.online === 1 ? "Online" : "Offline";
						}
					});
				}
				function updatePaginationButtons() {
					currentPage > 1 ? prevButton.classList.add("mystyle") : prevButton.classList.remove("mystyle");
					currentPage * rowsPerPage < arrUsers.length ? nextButton.classList.add("mystyle") : nextButton.classList.remove("mystyle");
				}
				checkAll.addEventListener("change", function() {
					const checkboxes = tableBody.querySelectorAll('input[type="checkbox"][name="selectedUsers"]');
					checkboxes.forEach(checkbox => {
						checkbox.checked = this.checked;
					});
				});
				prevButton.addEventListener("click", () => {
					if ( currentPage > 1 ) {
						currentPage--;
						allUsersData = {}; // Reset dữ liệu đã tải
						fetchAllUsersData(arrUsers.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage));
						updatePaginationButtons();
					}
				});
				nextButton.addEventListener("click", () => {
					if ( currentPage * rowsPerPage < arrUsers.length ) {
						currentPage++;
						allUsersData = {}; // Reset dữ liệu đã tải
						fetchAllUsersData(arrUsers.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage));
						updatePaginationButtons();
					}
				});
				database.ref(`${accounts}/${loggedInUser}`).once("value", (snapshot) => {
					// Phần mã hiển thị thông tin người dùng đã đăng nhập vẫn giữ nguyên
					if ( snapshot.exists() ) {
						let data = snapshot.val();
						document.getElementById("dashboard").innerHTML = `... (phần HTML dashboard của bạn) ...`;
						document.getElementById("btn-logout").addEventListener("click", (e) => {
							e.preventDefault();
							database.ref(`${accounts}/${loggedInUser}/status/online`).set("0");
							localStorage.removeItem("social-media-auth");
							window.location.href = "https://hiepdeep.github.io/ref/auth";
						});
						database.ref(`app/visit`).on("value", (snapshot) => {
							const visits = snapshot.val() || 0;
							document.getElementById("app-views").textContent = makerNumber(visits);
						});
					}
				});
				function makerNumber(num) {
					return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
				}
			} else {
				window.location.href = "https://hiepdeep.github.io/ref/auth";
			}
		</script>
	</body>
</html>